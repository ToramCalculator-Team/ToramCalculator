# 通信协议表（Simulator v1）

本文档描述 ToramCalculator 实时模拟器（主线程 ↔ Worker）的通信协议，目标是把通信层收敛为**清晰、可维护、可扩展**的规则：  
- **Task/RPC（请求-响应）**：一次性命令/一次性查询/订阅管理  
- **Push/Stream（系统消息）**：Worker 主动推送的事件流/渲染指令/状态镜像/调试数据帧  

> 注：当前代码仍处于迁移期，部分消息类型存在“现状 ≠ 目标态”。协议表会同时标注两者，便于按表收敛。

---

## 总体规则（必须遵守）

### 1) 两类协议二选一

- **Task/RPC**：必须有明确返回值（success/error），允许超时/重试/优先级调度。
- **Push/Stream**：不依赖请求，消费者只监听；适合变化驱动/连续输出。

### 2) 高频数据禁止走 Task/RPC

- 任意 **>= 10Hz** 的数据流必须走 Push（否则会挤爆队列，破坏优先级）。

### 3) 顶层消息类型必须“语义单一”

- 不允许把多种语义混进同一个顶层 type 后再在 payload 里二次分发（例如把领域事件塞进 `system_event`）。

---

## 协议表 A：Task/RPC（请求-响应）

**承载**：`WorkerMessage { belongToTaskId, payload, priority }` → `WorkerMessageEvent { belongToTaskId, result/error }`  
**入口**：`SimulatorPool.executeTask(taskType, payload, priority)`  

| 名称 | taskType | payload.type | 方向 | 频率 | 返回 | 生产者 | 消费者 | 现状实现 | 目标态 |
|---|---|---|---|---|---|---|---|---|---|
| 引擎生命周期命令 | `engine_command` | `EngineControlMessage` | Main → Worker | 低频 | success/error | `EngineLifecycleController` | `Simulation.worker.ts` → `gameEngine.sendCommand(...)` | ✅ 已实现 | 保持 |
| 获取成员列表 | `data_query` | `get_members` | Main → Worker | 低频 | `MemberSerializeData[]` | UI | `handleDataQuery` | ✅ 已实现 | 保持 |
| 获取引擎统计 | `data_query` | `get_stats` | Main → Worker | 低频 | `EngineStats` | UI | `handleDataQuery` | ✅ 已实现 | 保持 |
| 获取当前快照（一次性） | `data_query` | `get_snapshot` | Main → Worker | 低频 | snapshot | UI/调试 | `handleDataQuery` | ✅ 已实现 | 保持（用于调试/校正） |
| 获取单成员 FSM 状态 | `data_query` | `get_member_state` | Main → Worker | 低频 | `{memberId,value}` | UI/调试 | `handleDataQuery` | ✅ 已实现 | 保持 |
| 发送意图（控制输入） | `data_query` | `send_intent` | Main → Worker | 中频 | success/error | `MemberController` | `gameEngine.processIntent(intent)` | ✅ 已实现 | 目标态建议独立为 `control_intent`（可选） |
| 订阅调试视图（井盖） | （新增） | `subscribe_debug_view` | Main → Worker | 低频 | `{viewId}` | Debug 面板 | Worker 注册订阅 | ❌ 未实现 | ✅ 目标态新增（仅订阅管理走 Task） |
| 取消订阅调试视图 | （新增） | `unsubscribe_debug_view` | Main → Worker | 低频 | success/error | Debug 面板 | Worker 取消订阅 | ❌ 未实现 | ✅ 目标态新增 |

---

## 协议表 B：Push/Stream（系统消息）

**承载**：`WorkerSystemMessageSchema`，在 `SimulatorPool` 中被识别并 emit 为事件：  
- `system_event`  
- `frame_snapshot`  
- `render_cmd`  
- `engine_state_machine`  

> 目标态建议把 `system_event` 拆解为语义更清晰的顶层 type：`domain_event_batch`、`worker_event`（或保留 `system_event` 但严格限制语义）。

| 名称 | 顶层 type | 方向 | 频率 | 是否需要订阅 | payload schema/形状 | 生产者 | 消费者 | 现状实现 | 目标态 |
|---|---|---|---|---|---|---|---|---|---|
| 引擎状态机镜像 | `engine_state_machine` | Worker → Main | 低频/变化驱动 | 否 | `EngineControlMessage`（镜像） | `GameEngine.setMirrorSender` → `messagePort.postMessage(...)` | `EngineLifecycleController`（转发到 actor） | ✅ 已实现（但走“单独出口”，不是 `postSystemMessage`） | ✅ 统一为同一个 push 出口（建议） |
| 渲染指令 | `render_cmd` | Worker → Main | 中频/高频 | 否 | `RendererCmd` / `render:cmd(s)` | `gameEngine.setRenderMessageSender` | `RendererCommunication` / UI | ✅ 已实现 | 保持 |
| 帧快照（向后兼容） | `frame_snapshot` | Worker → Main | 高频（当前 60FPS） | 否 | `FrameSnapshot` | `gameEngine.setFrameSnapshotSender` | `RealtimeSimulator` | ✅ 已实现 | 目标态：默认关闭或降频；只用于真正需要的观测/校正 |
| 系统事件（杂项） | `system_event` | Worker → Main | 低频/变化驱动 | 否 | `{type: string, ...}`（不统一） | `gameEngine.setSystemMessageSender` | `RealtimeSimulator`（二次分发） | ✅ 已实现（包含 `controller_domain_event_batch`） | 目标态：拆出 `domain_event_batch`，`system_event` 只保留 worker_ready/error 等 |
| 控制器领域事件批 | （现状在 `system_event` 内） | Worker → Main | 低频/变化驱动 | 否 | `{type:"controller_domain_event_batch", events: ControllerDomainEvent[]}` | `ControllerEventProjector` | UI 状态管理（controllerEventState） | ✅ 已实现（但“嵌套在 system_event”） | ✅ 提升为顶层 `domain_event_batch`（建议） |
| Worker 就绪 | （现状在 `system_event` 内） | Worker → Main | once | 否 | `{type:"worker_ready", workerId}` | `Simulation.worker.ts` | UI/调试 | ✅ 已实现 | 保持（可归入 `worker_event`） |
| 调试视图数据帧（井盖） | （新增） | Worker → Main | 中频/高频（建议默认 10Hz） | 是 | `{viewId, controllerId, memberId, frame, data}` | DebugStream 服务 | Debug 面板 store | ❌ 未实现 | ✅ 目标态新增（仅订阅者接收） |

---

## 现状代码映射（入口文件）

- Worker 入口：`src/components/features/simulator/core/thread/Simulation.worker.ts`
- 主线程池：`src/components/features/simulator/core/thread/SimulatorPool.ts`
- UI 同步入口：`src/components/features/simulator/RealtimeSimulator.tsx`（注册 push 监听 + 维护 UI state）
- 渲染通信：`src/components/features/simulator/render/RendererCommunication.ts`
- 领域事件投影：`src/components/features/simulator/core/DomainEvents/ControllerEventProjector.ts`

---

## 收敛建议（按协议表推进）

### 1) 顶层语义收敛（优先级最高）

- 将 `{type:"controller_domain_event_batch"}` 从 `system_event` 提升为顶层 `domain_event_batch`（或直接复用 `domain_event_batch` 这个系统消息 type）。
- 将 `engine_state_machine` 纳入统一的 push 出口（`postSystemMessage`），避免“双出口”。

### 2) 降低常驻高频负载

- `frame_snapshot` 默认关闭或降频（仅当存在消费方时启用）。
- `debug_view_frame` 采用订阅制（井盖），默认 10Hz，可配置。


