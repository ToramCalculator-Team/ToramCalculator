# ğŸ—ï¸ ToramCalculator çŠ¶æ€åŒæ­¥æ¶æ„è®¾è®¡

## ğŸ“‹ é—®é¢˜åˆ†æ

### åŸå§‹æ¶æ„çš„é—®é¢˜
1. **èŒè´£æ··ä¹±**ï¼šGameEngineä½œä¸ºå®¹å™¨ï¼Œä¸åº”è¯¥ç›´æ¥å¤„ç†é€šä¿¡ç»†èŠ‚
2. **è€¦åˆè¿‡ç´§**ï¼šMemberç›´æ¥è°ƒç”¨engine.emitï¼Œè¿åäº†åˆ†å±‚åŸåˆ™
3. **é€šä¿¡æœºåˆ¶åˆ†æ•£**ï¼šäº‹ä»¶å‘å°„å’Œæ¶ˆæ¯è·¯ç”±åˆ†æ•£åœ¨ä¸åŒæ¨¡å—

## ğŸ¯ æ­£ç¡®çš„æ¶æ„è®¾è®¡

### æ ¸å¿ƒåŸåˆ™
- **å•ä¸€èŒè´£**ï¼šæ¯ä¸ªæ¨¡å—åªè´Ÿè´£è‡ªå·±çš„æ ¸å¿ƒåŠŸèƒ½
- **åˆ†å±‚æ¸…æ™°**ï¼šé€šä¿¡å±‚ã€ä¸šåŠ¡å±‚ã€æ•°æ®å±‚èŒè´£æ˜ç¡®
- **ç»Ÿä¸€å…¥å£**ï¼šæ‰€æœ‰å¯¹å¤–é€šä¿¡éƒ½é€šè¿‡MessageRouter

### æ¶æ„å±‚æ¬¡

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ä¸»çº¿ç¨‹ (Main Thread)                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  SimulatorPool â†â†’ Controller â†â†’ UI Components              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â†• MessageChannel
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Workerçº¿ç¨‹ (Worker Thread)               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  GameEngine (å®¹å™¨)                                          â”‚
â”‚  â”œâ”€â”€ MemberManager (æˆå‘˜ç®¡ç†)                               â”‚
â”‚  â”œâ”€â”€ MessageRouter (æ¶ˆæ¯è·¯ç”± + çŠ¶æ€åŒæ­¥) â†â”€â”€â”              â”‚
â”‚  â”œâ”€â”€ FrameLoop (å¸§å¾ªç¯)                     â”‚              â”‚
â”‚  â”œâ”€â”€ EventQueue (äº‹ä»¶é˜Ÿåˆ—)                  â”‚              â”‚
â”‚  â””â”€â”€ EventHandlerFactory (äº‹ä»¶å¤„ç†å™¨å·¥å‚)    â”‚              â”‚
â”‚                                              â”‚              â”‚
â”‚  Member (æˆå‘˜å®ä¾‹)                           â”‚              â”‚
â”‚  â”œâ”€â”€ Actor (çŠ¶æ€æœº)                          â”‚              â”‚
â”‚  â”œâ”€â”€ ReactiveSystem (å“åº”å¼ç³»ç»Ÿ)             â”‚              â”‚
â”‚  â””â”€â”€ çŠ¶æ€å˜åŒ–ç›‘å¬å™¨ â†’ MessageRouter.syncMemberState() â”€â”€â”€â”€â”€â”€â”˜
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ•°æ®æµå‘

#### 1. çŠ¶æ€æ›´æ–°æµç¨‹
```
MemberçŠ¶æ€å˜åŒ– â†’ Actor.subscribe() â†’ MessageRouter.syncMemberState() â†’ ä¸»çº¿ç¨‹
```

#### 2. å¤–éƒ¨æŒ‡ä»¤æµç¨‹
```
ä¸»çº¿ç¨‹ â†’ MessageRouter.processMessage() â†’ Member.actor.send() â†’ FSMå¤„ç†
```

#### 3. çŠ¶æ€åŒæ­¥æµç¨‹
```
MessageRouter.syncState() â†’ çŠ¶æ€åŒæ­¥å›è°ƒ â†’ postSystemMessage() â†’ ä¸»çº¿ç¨‹
```

## ğŸ”§ å®ç°ç»†èŠ‚

### MessageRouter èŒè´£æ‰©å±•
```typescript
export class MessageRouter {
  // åŸæœ‰èŒè´£ï¼šæ¶ˆæ¯è·¯ç”±
  async processMessage(message: IntentMessage): Promise<MessageProcessResult>
  
  // æ–°å¢èŒè´£ï¼šçŠ¶æ€åŒæ­¥
  setStateSyncCallback(callback: StateSyncCallback): void
  syncState(eventType: string, data: any): void
  syncMemberState(memberId: string, state: any): void
}
```

### GameEngine èŒè´£ç®€åŒ–
```typescript
export class GameEngine {
  // ç§»é™¤äº‹ä»¶å‘å°„å™¨åŠŸèƒ½
  // é€šè¿‡MessageRouterç»Ÿä¸€ç®¡ç†çŠ¶æ€åŒæ­¥
  
  setStateSyncCallback(callback: (eventType: string, data: any) => void): void
}
```

### Member èŒè´£æ˜ç¡®
```typescript
export class Member {
  // çŠ¶æ€å˜åŒ–æ—¶ï¼Œé€šè¿‡MessageRouteråŒæ­¥
  this.actor.subscribe((snapshot) => {
    this.engine.getMessageRouter().syncMemberState(this.id, snapshot);
  });
}
```

## âœ… æ¶æ„ä¼˜åŠ¿

### 1. èŒè´£æ¸…æ™°
- **GameEngine**ï¼šå®¹å™¨ï¼Œåè°ƒå„æ¨¡å—
- **MessageRouter**ï¼šç»Ÿä¸€çš„æ¶ˆæ¯è·¯ç”±å’ŒçŠ¶æ€åŒæ­¥
- **Member**ï¼šä¸šåŠ¡é€»è¾‘ï¼Œä¸å…³å¿ƒé€šä¿¡ç»†èŠ‚

### 2. è§£è€¦åˆ
- Memberä¸éœ€è¦çŸ¥é“å¦‚ä½•ä¸ä¸»çº¿ç¨‹é€šä¿¡
- GameEngineä¸“æ³¨äºå®¹å™¨èŒè´£
- é€šä¿¡é€»è¾‘é›†ä¸­åœ¨MessageRouter

### 3. å¯ç»´æŠ¤æ€§
- çŠ¶æ€åŒæ­¥é€»è¾‘é›†ä¸­ç®¡ç†
- æ˜“äºæ·»åŠ æ–°çš„åŒæ­¥ç±»å‹
- ç»Ÿä¸€çš„é”™è¯¯å¤„ç†å’Œç»Ÿè®¡

### 4. æ‰©å±•æ€§
- å¯ä»¥è½»æ¾æ·»åŠ æ–°çš„åŒæ­¥äº‹ä»¶ç±»å‹
- æ”¯æŒä¸åŒçš„åŒæ­¥ç­–ç•¥ï¼ˆå®æ—¶ã€æ‰¹é‡ã€èŠ‚æµç­‰ï¼‰
- ä¾¿äºæ·»åŠ ç›‘æ§å’Œè°ƒè¯•åŠŸèƒ½

## ğŸš€ æœªæ¥æ‰©å±•

### 1. åŒæ­¥ç­–ç•¥
- å®æ—¶åŒæ­¥ï¼šé‡è¦çŠ¶æ€å˜åŒ–ç«‹å³åŒæ­¥
- æ‰¹é‡åŒæ­¥ï¼šéå…³é”®çŠ¶æ€æ‰¹é‡å¤„ç†
- èŠ‚æµåŒæ­¥ï¼šé«˜é¢‘çŠ¶æ€å˜åŒ–èŠ‚æµå¤„ç†

### 2. ç›‘æ§å’Œè°ƒè¯•
- åŒæ­¥æ€§èƒ½ç›‘æ§
- çŠ¶æ€å˜åŒ–å†å²è®°å½•
- è°ƒè¯•å·¥å…·é›†æˆ

### 3. é”™è¯¯å¤„ç†
- åŒæ­¥å¤±è´¥é‡è¯•æœºåˆ¶
- ç½‘ç»œå¼‚å¸¸å¤„ç†
- é™çº§ç­–ç•¥

## ğŸ“ æ€»ç»“

é€šè¿‡é‡æ„ï¼Œæˆ‘ä»¬å®ç°äº†ï¼š
1. **æ¸…æ™°çš„èŒè´£åˆ†ç¦»**ï¼šæ¯ä¸ªæ¨¡å—åªè´Ÿè´£è‡ªå·±çš„æ ¸å¿ƒåŠŸèƒ½
2. **ç»Ÿä¸€çš„é€šä¿¡å…¥å£**ï¼šMessageRouteræˆä¸ºæ‰€æœ‰å¯¹å¤–é€šä¿¡çš„ç»Ÿä¸€å…¥å£
3. **æ›´å¥½çš„å¯ç»´æŠ¤æ€§**ï¼šçŠ¶æ€åŒæ­¥é€»è¾‘é›†ä¸­ï¼Œæ˜“äºç»´æŠ¤å’Œæ‰©å±•
4. **ç¬¦åˆæ¶æ„åŸåˆ™**ï¼šéµå¾ªå•ä¸€èŒè´£ã€å¼€é—­åŸåˆ™ç­‰è®¾è®¡åŸåˆ™

è¿™ç§è®¾è®¡è®©ç³»ç»Ÿæ›´åŠ å¥å£®ã€å¯ç»´æŠ¤ï¼Œå¹¶ä¸”ä¸ºæœªæ¥çš„åŠŸèƒ½æ‰©å±•å¥ å®šäº†è‰¯å¥½çš„åŸºç¡€ã€‚
